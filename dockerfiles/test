FROM debian:bookworm
ARG DEBIAN_FRONTEND=noninteractive

# System update with cleanup
RUN apt-get clean && \
    apt-get update && \
    apt-get -y upgrade && \
    apt-get -y install --no-install-recommends \
        apt-utils gcc \
        python3 vim unzip curl \
        fakeroot dbus-base whiptail hexedit \
        patch file make dialog \
        less cowsay netcat-openbsd \
        # GUI components
        xvfb fluxbox x11-apps \
        # GUI libraries
        libgtk-3-0 libnss3 libxss1 libasound2 libxtst6 \
        libxcb1 libx11-xcb1 libxcb-icccm4 libxcb-keysyms1 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# User setup
RUN useradd -m user && echo "user:password" | chpasswd && \
    echo 'root:password' | chpasswd

# Copy only essential examples
COPY --chown=user:user ./examples/lua /home/user/examples/lua
RUN chmod -R +x /home/user/examples/lua

# Download and install CEmu directly
RUN mkdir -p /home/user/cemu && \
    curl -L -o /tmp/cemu.zip https://github.com/CE-Programming/CEmu/releases/download/v2.0/CEmu-v2.0_linux_Qt6-static.zip && \
    unzip /tmp/cemu.zip -d /home/user/cemu && \
    chmod +x /home/user/cemu/CEmu && \
    rm /tmp/cemu.zip

# Environment configuration
WORKDIR /home/user/
ENV HOME="/home/user" \
    TERM="xterm" \
    USER="user" \
    SHELL="/bin/bash" \
    EDITOR="vim" \
    LANG="C.UTF-8" \
    DISPLAY=":0"

# Minimal startup script
RUN echo '#!/bin/bash\n\
Xvfb $DISPLAY -screen 0 1024x768x16 &\n\
fluxbox -display $DISPLAY &\n\
exec "$@"' > /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/bin/bash"]
